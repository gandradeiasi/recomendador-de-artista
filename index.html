<!DOCTYPE html>
<html>
<head>
    <title>Recomendador de Artistas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 2rem;
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }

        #login {
            display: block;
            margin: 2rem auto;
            padding: 1rem 2rem;
            background-color: #1DB954;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #login:hover {
            transform: scale(1.05);
        }

        .recommendation-button {
            width: calc(100% - 4rem);
            min-height: 80px;
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            text-decoration: none;
            color: inherit;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .recommendation-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .artist-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }

        .artist-info {
            flex: 1;
        }

        .artist-name {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .artist-genres {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        #progressContainer {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .status-message {
            text-align: center;
            margin: 2rem 0;
            color: #444;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <button id="login">Login com Spotify</button>
    <div id="progressContainer">
        <div>Carregando suas músicas...</div>
        <progress id="progress" value="0" max="1"></progress>
    </div>
    <div id="status" class="status-message"></div>
    <div id="results"></div>

    <script>
        const clientId = 'cdbe0b644b984a6e98839e352d87bb3d';
        const redirectUri = 'https://gandradeiasi.github.io/recomendador-de-artista/';

        if(window.location.hash.includes('access_token')) {
            document.getElementById('login').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'block';
        }

        document.getElementById('login').addEventListener('click', () => {
            const scope = 'user-library-read';
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}&response_type=token`;
            window.location = authUrl;
        });

        async function main() {
            try {
                const accessToken = window.location.hash.split('&')[0].split('=')[1];
                
                showStatus('Buscando suas músicas salvas...');
                const savedTracks = await getAllSavedTracks(accessToken);
                console.log('Músicas encontradas:', savedTracks.length);
                
                showStatus('Analisando seus artistas...');
                const artistDetails = await getArtistGenres(accessToken, savedTracks);
                console.log('Artistas únicos:', Object.keys(artistDetails).length);
                
                const genreCounts = processGenres(savedTracks, artistDetails);
                console.log('Distribuição de gêneros:', genreCounts);
                
                const elbowGenres = findElbowGenres(genreCounts);
                console.log('Gêneros selecionados:', elbowGenres);
                
                showStatus('Buscando recomendações...');
                const recommendations = await getRecommendations(accessToken, elbowGenres, savedTracks);
                console.log('Recomendações encontradas:', recommendations.length, recommendations);
                
                // Garantir pelo menos 3 recomendações
                if(recommendations.length < 3) {
                    console.log('Buscando recomendações adicionais...');
                    const additionalGenres = genreCounts.slice(-3).reverse();
                    const extraRecs = await getRecommendations(accessToken, additionalGenres, savedTracks);
                    recommendations.push(...extraRecs.filter(r => !recommendations.includes(r)));
                }
                
                displayResults(recommendations.slice(0, 3));
            } catch (error) {
                console.error('Erro:', error);
                showStatus('Ocorreu um erro. Por favor tente novamente.');
            }
        }

        // Funções auxiliares mantidas com ajustes
        async function getRecommendations(accessToken, genres, savedTracks) {
            const savedArtists = new Set(
                savedTracks.flatMap(t => t.track.artists.map(a => a.id))
            );
            
            const recommendations = [];
            const usedArtists = new Set();
            
            for(const genre of genres) {
                let offset = 0;
                let attempts = 0;
                
                while(offset < 500 && attempts < 3) {
                    const response = await fetch(
                        `https://api.spotify.com/v1/search?q=genre:${encodeURIComponent(genre[0])}&type=artist&limit=50&offset=${offset}`,
                        { headers: {'Authorization': `Bearer ${accessToken}`} }
                    );
                    const data = await response.json();
                    
                    const validArtists = data.artists.items.filter(artist => 
                        artist.genres.includes(genre[0]) && 
                        !savedArtists.has(artist.id) &&
                        !usedArtists.has(artist.id)
                    );
                    
                    if(validArtists.length > 0) {
                        const randomArtist = validArtists[Math.floor(Math.random() * validArtists.length)];
                        recommendations.push(randomArtist);
                        usedArtists.add(randomArtist.id);
                        break;
                    }
                    
                    offset += 50;
                    attempts++;
                }
                
                if(recommendations.length >= 3) break;
            }
            return recommendations;
        }

        function displayResults(artists) {
            const container = document.getElementById('results');
            container.innerHTML = '<h2 style="text-align:center;margin-bottom:2rem">Artistas Recomendados</h2>';
            
            artists.forEach(artist => {
                const button = document.createElement('a');
                button.className = 'recommendation-button';
                button.href = artist.external_urls.spotify;
                button.target = '_blank';
                
                button.innerHTML = `
                    <img class="artist-image" src="${artist.images[0]?.url || 'https://via.placeholder.com/150'}" alt="${artist.name}">
                    <div class="artist-info">
                        <h3 class="artist-name">${artist.name}</h3>
                        <p class="artist-genres">${(artist.genres || []).slice(0, 3).join(' • ')}</p>
                    </div>
                `;
                
                container.appendChild(button);
            });
        }

        // Demais funções mantidas conforme versão anterior (getAllSavedTracks, getArtistGenres, processGenres, findElbowGenres, etc.)

        if(window.location.hash.includes('access_token')) {
            main();
        }
    </script>
</body>
</html>
